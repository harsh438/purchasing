general:
  build_dir: api

machine:
  node:
    version: 4.1.0

dependencies:
  pre:
    - gem install eb_deployer
    - gem install slack-notifier
  post:
    - npm install:
        pwd: ../frontend/
    - npm run build:
        pwd: ../frontend/

database:
  override:
    - cp config/database.ci.yml config/database.yml
    - bundle exec rake db:create db:schema:load

test:
  override:
    - bundle exec rake build

deployment:
  staging:
    branch: [devops, staging]
    commands:
      - aws s3 cp --recursive "s3://$S3_DEPLOYMENT_BUCKET/devops/" .
      - chmod +x deploy-new.sh
      - ./deploy-new.sh
  production:
    branch: [production]
    commands:
      - aws s3 cp --recursive "s3://$S3_DEPLOYMENT_BUCKET/devops/" .
      - chmod +x deploy-new.sh
      - ./deploy-new.sh
